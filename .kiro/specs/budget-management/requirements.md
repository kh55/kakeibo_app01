# Requirements Document

## Project Description (Input)
予算管理の機能を完成

## Introduction

家計簿アプリの予算管理機能について、カテゴリ別予算の設定と進捗確認を一貫して利用できるようにするための要件を定義する。既存の予算CRUD・年月絞り込みを前提に、進捗表示とデータ整合性を「完成」の範囲に含める。

---

## Requirements

### 1. 予算の登録・編集・削除

**Objective:** ログイン済みユーザーとして、年月・カテゴリごとに予算額を登録・編集・削除したい。その月の支出目標を設定し、実績と比較できるようにするため。

#### Acceptance Criteria

1. When ユーザーが予算の新規登録画面で年月・カテゴリ・金額を入力して送信する, the system shall 当該ユーザーに紐づく予算を1件作成し、その年月の予算一覧へリダイレクトする。
2. When ユーザーが既存予算の編集画面で金額等を変更して送信する, the system shall 当該予算を更新し、その年月の予算一覧へリダイレクトする。
3. When ユーザーが予算の削除を確認する, the system shall 当該予算を削除し、予算一覧へリダイレクトする。
4. If 年月・カテゴリ・金額のいずれかが不正または未入力である, the system shall 登録・更新を行わず、エラーメッセージを表示する。
5. The system shall 予算の登録・編集・削除を、当該予算の所有者（user_id が一致するユーザー）にのみ許可する。

---

### 2. 予算一覧と年月での絞り込み

**Objective:** ログイン済みユーザーとして、指定した年月のカテゴリ別予算一覧を確認したい。月ごとの予算を把握するため。

#### Acceptance Criteria

1. When ユーザーが予算一覧画面にアクセスする, the system shall デフォルトで当月の年月を用い、当該ユーザーのその年月の予算一覧を表示する。
2. When ユーザーが年・月を指定してフィルタを実行する, the system shall 指定された年月に紐づく当該ユーザーの予算一覧のみを表示する。
3. The system shall 一覧にカテゴリ名・予算額・編集・削除操作を表示する。
4. The system shall 予算一覧には当該ユーザーが所有する予算のみを含める。

---

### 3. 予算に対する進捗（実績）の表示

**Objective:** ログイン済みユーザーとして、各カテゴリの予算額とその月の実績支出を一覧で比較したい。予算の消化状況を把握するため。

#### Acceptance Criteria

1. When ユーザーが指定年月の予算一覧を表示する, the system shall 各予算行に、その年月・そのカテゴリに紐づく支出取引の合計額（実績）を表示する。
2. When 実績が存在する場合, the system shall 予算額・実績額・残り（予算－実績）、および必要に応じて達成率または超過の有無を判別可能に表示する。
3. When その年月・カテゴリに支出取引が一件もない場合, the system shall 実績を 0 として表示する。
4. The system shall 実績の算出対象を、当該ユーザーが所有し、指定年月内で日付が含まれる支出（type=expense）取引に限定する。

---

### 4. 認可とデータ分離

**Objective:** システム利用者として、他ユーザーの予算にアクセス・改ざんできないことを保証されたい。個人データの分離のため。

#### Acceptance Criteria

1. When ユーザーが自分が所有しない予算の編集・削除をリクエストする, the system shall 403 Forbidden を返し、操作を実行しない。
2. When ユーザーが予算一覧を取得する, the system shall user_id が自ユーザーと一致する予算のみを返す。
3. The system shall 予算の作成時に、必ずリクエストしているユーザーの user_id を紐づける。

---

### 5. 同一年月・カテゴリの重複防止（任意）

**Objective:** ログイン済みユーザーとして、同じ年月・同じカテゴリに予算が二重に登録されないようにしたい。一覧での進捗が一意に解釈できるようにするため。

#### Acceptance Criteria

1. When ユーザーが新規予算を登録する, the system shall 同一 user_id・同一 year・同一 month・同一 category_id の予算が既に存在する場合は登録を拒否し、エラーメッセージを表示する。
2. When ユーザーが既存予算を編集する, the system shall 同一 user_id・同一 year・同一 month・同一 category_id の別レコードが既に存在する場合は更新を拒否し、エラーメッセージを表示する。
