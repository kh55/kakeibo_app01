# Implementation Plan: 予算管理の機能を完成

## Task Format

- 各タスクは能力・成果で記述し、ファイル名やメソッド名は出さない。
- 要件カバーは `_Requirements: N.M_` で番号のみ記載する。
- `(P)` は並行実行可能な場合に付与する（本プランではテストタスクのみ付与）。

---

- [x] 1. 予算一覧に実績・残り・超過を表示する
- [x] 1.1 一覧取得時に指定年月・当該ユーザーの支出をカテゴリ別に集計し、各予算に実績額・残り・超過有無を付与して一覧用データに含める
  - 集計対象は当該ユーザー・指定年月・支出（type=expense）の取引のみとする。
  - 1 クエリで category_id 別の合計を取得し、各予算行に実績・残り・超過フラグを付与する。
  - _Requirements: 3.1, 3.3, 3.4, 2.1, 2.4_
- [x] 1.2 一覧画面に実績額・残り・達成率または超過の列を追加し、取引がないカテゴリは実績を 0 で表示する
  - 残りが負の場合は「超過」等で判別可能に表示する。
  - _Requirements: 3.2, 3.3, 2.3_

- [x] 2. 予算の登録・編集時の重複検証とエラー表示
- [x] 2.1 新規登録時に同一ユーザー・年・月・カテゴリの予算が既に存在する場合はバリデーションで拒否し、友好的なエラーメッセージを表示する
  - _Requirements: 5.1, 1.4_
- [x] 2.2 編集時に同一ユーザー・年・月・カテゴリの別予算が既に存在する場合はバリデーションで拒否し、友好的なメッセージを表示する。DB の unique 違反時は同様のメッセージで 422 を返すフォールバックを用意する
  - バリデーションでは当該予算の id を除外して重複を判定する。
  - _Requirements: 5.2, 1.4_

- [x] 3. 予算管理の Feature テストで動作を検証する
- [x] 3.1 (P) 一覧の年月フィルタ・実績表示・登録・編集・削除後のリダイレクト・当該ユーザーの予算のみ表示が設計どおりであることを Feature テストで検証する
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 1.1, 1.2, 1.3, 4.2, 4.3_
- [x] 3.2 (P) 重複登録・重複更新で 422 と友好的メッセージが返ること、他ユーザー予算の編集・削除で 403 となることを Feature テストで検証する
  - _Requirements: 5.1, 5.2, 4.1, 1.5_
